# PoC: Integration with Flagger

This example shows a integration of Keptn Metrics
into a Flagger Canary.
In this example, we are making use of the Prometheus endpoint provided
by Keptn (i.e. the metrics-operator), which serves the values of all `KeptnMetrics`.

This way, we are able to use a Flagger `MetricTemplate` of type `prometheus`,
which retrieves the value from a Prometheus instance that has access to the `KeptnMetrics`.

The example is based on the [Istio Canary Deployments tutorial](https://docs.flagger.app/tutorials/istio-progressive-delivery)
provided in the Flagger docs.

The difference to the tutorial is that instead of using the `request-duration` duration
provided by Istio via Prometheus, we are referring to a `KeptnMetric` called `response-time`.
The Flagger metrics provider is in this case still `prometheus`.

What could be an interesting idea would be to contribute to Flagger by adding
a `keptn` metrics provider to their [provider implementations](https://github.com/fluxcd/flagger/tree/main/pkg/metrics/providers).
This would also open up the possibility to use Keptn `Analyses` in Flagger, which might be a
valuable addition that benefits both projects.

In terms of observability, we do get the OpenTelemetry traces generated by Keptn out of the box
if the relevant annotations are present in the deployment managed by Flagger.

The addition of pre-/post-deployment tasks using Keptn is also possible,
but here Flagger provides a similar concept via [Webhooks](https://docs.flagger.app/usage/webhooks),
which are naturally more tailored to Flagger as they also allow to do intermediate checks after the
pods for the canary deployment have been started, e.g. to decide if more traffic should be sent to the canary.
This is something Keptn does not provide, as we operate on pre-/post-deployment of the deployment, but
are not aware of the canary increments of Flagger.
 